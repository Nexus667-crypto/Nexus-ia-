<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nexus ‚Äî AI Platform</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Exo+2:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --violet:#4b0fd4;--violet-mid:#6b2cf5;--violet-bright:#8b5cf6;
  --blue:#3b82f6;--cyan:#06b6d4;--pink:#ec4899;--gold:#f59e0b;
  --white:#f0f0ff;--muted:#8080b0;
  --border:rgba(139,92,246,0.25);--card:rgba(11,5,40,0.78);
  --glow:rgba(107,44,245,0.4);
  --bg1:#03010a;--bg2:#080420;
}
html{scroll-behavior:smooth}
body{font-family:'Exo 2',sans-serif;background:var(--bg1);color:var(--white);overflow-x:hidden;min-height:100vh}
body.theme-blue{--violet:#0ea5e9;--violet-mid:#0284c7;--violet-bright:#38bdf8;--glow:rgba(14,165,233,0.4);--bg1:#00080f;--bg2:#001220}
body.theme-green{--violet:#059669;--violet-mid:#047857;--violet-bright:#34d399;--glow:rgba(5,150,105,0.4);--bg1:#00090a;--bg2:#001a0f}
body.theme-pink{--violet:#db2777;--violet-mid:#be185d;--violet-bright:#f472b6;--glow:rgba(219,39,119,0.4);--bg1:#0a0008;--bg2:#1a0010}
#spaceCanvas{position:fixed;inset:0;z-index:0;pointer-events:none}
.page{display:none;position:relative;z-index:1;min-height:100vh}

/* NAVBAR */
.navbar{position:fixed;top:0;left:0;right:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:0 40px;height:70px;background:rgba(3,1,10,0.88);backdrop-filter:blur(20px);border-bottom:1px solid var(--border)}
.nav-logo{font-family:'Orbitron',sans-serif;font-size:22px;font-weight:900;background:linear-gradient(90deg,var(--violet-bright),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:3px;cursor:pointer}
.nav-links{display:flex;align-items:center;gap:28px;list-style:none}
.nav-links a{color:var(--muted);text-decoration:none;font-size:14px;font-weight:500;cursor:pointer;transition:color .2s}
.nav-links a:hover{color:var(--white)}
.nav-right{display:flex;align-items:center;gap:10px}
.btn-nav{padding:8px 18px;border-radius:6px;font-family:'Exo 2',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--white)}
.btn-outline:hover{border-color:var(--violet-bright);color:var(--violet-bright)}
.btn-primary{background:linear-gradient(135deg,var(--violet),var(--violet-mid));border:1px solid rgba(139,92,246,.5);color:#fff;box-shadow:0 0 16px var(--glow)}
.btn-primary:hover{transform:translateY(-1px)}
#navUserArea{display:none;align-items:center;gap:10px}
#navUserName{font-size:13px;color:var(--violet-bright);font-weight:600;cursor:pointer}
#navUserName:hover{text-decoration:underline}
.role-badge{padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.role-normal{background:rgba(139,92,246,.15);color:var(--violet-bright);border:1px solid rgba(139,92,246,.3)}
.role-tester{background:rgba(6,182,212,.15);color:var(--cyan);border:1px solid rgba(6,182,212,.3)}
.role-premium{background:rgba(245,158,11,.15);color:var(--gold);border:1px solid rgba(245,158,11,.3)}
.role-creator{background:linear-gradient(135deg,rgba(236,72,153,.2),rgba(139,92,246,.2));color:#f9a8d4;border:1px solid rgba(236,72,153,.4)}
.credits-display{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:4px}
.credits-display span{color:var(--white);font-weight:700}

/* AUTH */
.auth-page{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:40px 20px}
.auth-card{width:100%;max-width:440px;background:var(--card);border:1px solid var(--border);border-radius:20px;padding:48px 40px;backdrop-filter:blur(30px);box-shadow:0 0 60px rgba(107,44,245,.15);animation:cardIn .4s ease}
@keyframes cardIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.auth-logo{font-family:'Orbitron',sans-serif;font-size:28px;font-weight:900;background:linear-gradient(90deg,var(--violet-bright),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:4px;text-align:center;margin-bottom:8px}
.auth-sub{text-align:center;color:var(--muted);font-size:14px;margin-bottom:36px}
.form-group{margin-bottom:20px}
.form-label{display:block;font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px}
.form-input{width:100%;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:13px 16px;color:var(--white);font-family:'Exo 2',sans-serif;font-size:14px;outline:none;transition:border-color .2s,box-shadow .2s}
.form-input:focus{border-color:var(--violet-bright);box-shadow:0 0 0 3px rgba(139,92,246,.15)}
.form-input::placeholder{color:rgba(128,128,176,.5)}
.btn-full{width:100%;padding:14px;border-radius:10px;font-family:'Exo 2',sans-serif;font-size:15px;font-weight:700;cursor:pointer;background:linear-gradient(135deg,var(--violet),var(--violet-mid));border:1px solid rgba(139,92,246,.4);color:#fff;transition:all .2s;box-shadow:0 4px 24px var(--glow);margin-top:8px}
.btn-full:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 32px var(--glow)}
.btn-full:disabled{opacity:.5;cursor:not-allowed;transform:none!important}
.auth-switch{text-align:center;margin-top:24px;font-size:13px;color:var(--muted)}
.auth-switch a{color:var(--violet-bright);cursor:pointer;font-weight:600}
.auth-err{background:rgba(236,72,153,.1);border:1px solid rgba(236,72,153,.3);border-radius:8px;padding:12px 14px;font-size:13px;color:#f9a8d4;margin-bottom:16px;display:none;line-height:1.6}
.auth-ok{background:rgba(6,182,212,.1);border:1px solid rgba(6,182,212,.3);border-radius:8px;padding:12px 14px;font-size:13px;color:#67e8f9;margin-bottom:16px;display:none}

/* VERIFY */
.verif-card{text-align:center;padding:48px 36px}
.verif-icon{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--violet),var(--cyan));display:flex;align-items:center;justify-content:center;font-size:36px;margin:0 auto 24px;box-shadow:0 0 40px var(--glow);animation:iconPulse 2s infinite}
@keyframes iconPulse{0%,100%{box-shadow:0 0 40px var(--glow)}50%{box-shadow:0 0 80px var(--glow)}}
.verif-title{font-family:'Orbitron',sans-serif;font-size:20px;font-weight:700;margin-bottom:12px}
.verif-text{color:var(--muted);font-size:14px;line-height:1.7;margin-bottom:16px}
.verif-email{background:rgba(139,92,246,.1);border:1px solid var(--border);border-radius:8px;padding:10px 16px;font-size:14px;color:var(--violet-bright);font-weight:600;margin-bottom:24px;word-break:break-all}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--muted);padding:10px 20px;border-radius:8px;font-family:'Exo 2',sans-serif;font-size:13px;cursor:pointer;transition:all .2s;margin-top:10px;display:inline-block}
.btn-ghost:hover{border-color:var(--violet-bright);color:var(--white)}

/* HOME */
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
@keyframes fadeUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
@keyframes shimmer{to{background-position:200% center}}
@keyframes orbP{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
@keyframes spin{to{transform:rotate(360deg)}}
.hero{min-height:100vh;display:flex;align-items:center;justify-content:center;text-align:center;padding:80px 40px}
.hero-content{max-width:800px;position:relative;z-index:2}
.hero-badge{display:inline-flex;align-items:center;gap:8px;background:rgba(139,92,246,.1);border:1px solid rgba(139,92,246,.3);border-radius:30px;padding:6px 16px;font-size:12px;color:var(--violet-bright);font-weight:600;letter-spacing:1px;text-transform:uppercase;margin-bottom:28px;animation:fadeUp .6s ease both}
.hero-badge::before{content:'';width:6px;height:6px;background:var(--cyan);border-radius:50%;animation:blink 2s infinite}
.hero-title{font-family:'Orbitron',sans-serif;font-size:clamp(36px,6vw,72px);font-weight:900;line-height:1.1;margin-bottom:24px;animation:fadeUp .6s .1s ease both}
.hero-title span{background:linear-gradient(135deg,var(--violet-bright),var(--cyan),var(--pink));background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shimmer 3s linear infinite}
.hero-sub{font-size:18px;color:var(--muted);line-height:1.7;max-width:560px;margin:0 auto 40px;animation:fadeUp .6s .2s ease both}
.hero-ctas{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;animation:fadeUp .6s .3s ease both}
.btn-hp{padding:16px 36px;background:linear-gradient(135deg,var(--violet),var(--violet-mid));border:1px solid rgba(139,92,246,.5);border-radius:10px;color:#fff;font-family:'Exo 2',sans-serif;font-size:16px;font-weight:700;cursor:pointer;transition:all .3s;box-shadow:0 0 30px var(--glow)}
.btn-hp:hover{transform:translateY(-3px);box-shadow:0 8px 40px var(--glow)}
.btn-hs{padding:16px 36px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;color:var(--white);font-family:'Exo 2',sans-serif;font-size:16px;font-weight:600;cursor:pointer;transition:all .2s}
.btn-hs:hover{border-color:var(--cyan);color:var(--cyan);transform:translateY(-2px)}
.section{padding:100px 40px;max-width:1200px;margin:0 auto}
.section-label{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:3px;color:var(--cyan);text-align:center;margin-bottom:12px}
.section-title{font-family:'Orbitron',sans-serif;font-size:clamp(28px,4vw,44px);font-weight:700;text-align:center;margin-bottom:16px;line-height:1.2}
.section-desc{text-align:center;color:var(--muted);font-size:16px;max-width:560px;margin:0 auto 60px;line-height:1.7}
.about-grid{display:grid;grid-template-columns:1fr 1fr;gap:60px;align-items:center}
.about-visual{position:relative;display:flex;align-items:center;justify-content:center;height:340px}
.about-orb{width:200px;height:200px;border-radius:50%;background:radial-gradient(circle,var(--violet-mid) 0%,var(--violet) 40%,transparent 70%);box-shadow:0 0 80px var(--glow);display:flex;align-items:center;justify-content:center;font-family:'Orbitron',sans-serif;font-size:28px;font-weight:900;color:#fff;letter-spacing:3px;animation:orbP 4s ease-in-out infinite}
.orbit-ring{position:absolute;border-radius:50%;border:1px solid rgba(139,92,246,.2);animation:spin linear infinite}
.ring-1{width:280px;height:280px;animation-duration:12s}
.ring-2{width:340px;height:340px;border-style:dashed;animation-duration:20s;animation-direction:reverse}
.orbit-dot{position:absolute;width:8px;height:8px;border-radius:50%;background:var(--cyan);box-shadow:0 0 12px rgba(6,182,212,.5);top:0;left:50%;transform:translateX(-50%) translateY(-4px)}
.about-features{display:flex;flex-direction:column;gap:20px}
.about-feat{display:flex;gap:16px;padding:20px;background:var(--card);border:1px solid var(--border);border-radius:12px;transition:all .2s}
.about-feat:hover{border-color:rgba(139,92,246,.5);transform:translateX(4px)}
.feat-icon{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--violet),var(--violet-mid));display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.feat-text h4{font-family:'Orbitron',sans-serif;font-size:14px;font-weight:700;margin-bottom:4px}
.feat-text p{font-size:13px;color:var(--muted);line-height:1.5}
.services-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:24px}
.svc-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:36px 28px;text-align:center;transition:all .3s}
.svc-card:hover{border-color:rgba(139,92,246,.5);transform:translateY(-6px);box-shadow:0 12px 40px rgba(107,44,245,.2)}
.svc-icon{width:72px;height:72px;border-radius:18px;background:linear-gradient(135deg,var(--violet),var(--blue));display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 20px}
.svc-title{font-family:'Orbitron',sans-serif;font-size:15px;font-weight:700;margin-bottom:12px}
.svc-desc{font-size:13px;color:var(--muted);line-height:1.6;margin-bottom:24px}
.btn-svc{padding:10px 24px;border-radius:8px;background:linear-gradient(135deg,var(--violet),var(--violet-mid));border:none;color:#fff;font-family:'Exo 2',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.btn-svc:hover{transform:scale(1.03)}
.contact-grid{display:grid;grid-template-columns:1fr 1fr;gap:48px;align-items:start}
.contact-info{display:flex;flex-direction:column;gap:20px}
.contact-item{display:flex;align-items:center;gap:16px;padding:16px 20px;background:var(--card);border:1px solid var(--border);border-radius:12px}
.contact-icon{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--violet),var(--violet-mid));display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.contact-detail h5{font-size:13px;font-weight:700;margin-bottom:2px}
.contact-detail p{font-size:13px;color:var(--muted)}
.contact-form{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:36px}
.contact-form-title{font-family:'Orbitron',sans-serif;font-size:18px;font-weight:700;margin-bottom:24px}
.footer{background:rgba(3,1,10,.9);border-top:1px solid var(--border);padding:40px;position:relative;z-index:1}
.footer-inner{display:flex;align-items:center;justify-content:space-between;max-width:1200px;margin:0 auto}
.footer-logo{font-family:'Orbitron',sans-serif;font-size:20px;font-weight:900;background:linear-gradient(90deg,var(--violet-bright),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:3px;margin-bottom:6px}
.footer-text{color:var(--muted);font-size:13px}
.footer-socials{display:flex;gap:12px}
.soc-btn{width:36px;height:36px;border-radius:8px;background:rgba(255,255,255,.05);border:1px solid var(--border);color:var(--muted);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s}
.soc-btn:hover{border-color:var(--violet-bright);color:var(--violet-bright)}

/* PRICING */
#pricingPage{padding-top:70px}
.pricing-hero{text-align:center;padding:80px 40px 40px}
.pricing-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:24px;max-width:1000px;margin:0 auto;padding:0 40px 80px}
.pricing-card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:36px 28px;text-align:center;transition:all .3s;position:relative}
.pricing-card.popular{border-color:var(--gold);box-shadow:0 0 40px rgba(245,158,11,.15)}
.popular-badge{position:absolute;top:-14px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--gold),#d97706);color:#000;padding:4px 16px;border-radius:20px;font-size:11px;font-weight:800;text-transform:uppercase;white-space:nowrap}
.pricing-card:hover{transform:translateY(-4px)}
.plan-icon{font-size:36px;margin-bottom:16px}
.plan-name{font-family:'Orbitron',sans-serif;font-size:18px;font-weight:700;margin-bottom:8px}
.plan-price{font-size:40px;font-weight:900;margin:16px 0 4px}
.plan-price span{font-size:16px;color:var(--muted);font-weight:400}
.plan-alt{font-size:12px;color:var(--muted);margin-bottom:24px}
.plan-features{list-style:none;text-align:left;margin-bottom:28px;display:flex;flex-direction:column;gap:10px}
.plan-features li{font-size:13px;color:var(--muted);display:flex;align-items:center;gap:8px}
.plan-features li::before{content:'‚úì';color:var(--cyan);font-weight:700;flex-shrink:0}
.btn-plan{width:100%;padding:12px;border-radius:10px;font-family:'Exo 2',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s;border:none}
.btn-plan-gold{background:linear-gradient(135deg,var(--gold),#d97706);color:#000}
.btn-plan-gold:hover{transform:translateY(-2px)}
.btn-plan-outline{background:transparent;border:1px solid var(--border)!important;color:var(--white)}
.btn-plan-outline:hover{border-color:var(--violet-bright)!important;color:var(--violet-bright)}

/* CHAT */
#chatPage{padding-top:70px;height:100vh;flex-direction:column}
.chat-container{flex:1;display:flex;overflow:hidden;height:calc(100vh - 70px)}
.chat-side{width:260px;min-width:260px;background:rgba(3,1,10,.95);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;transition:transform .3s;overflow:hidden}
.chat-side-top{padding:16px;display:flex;flex-direction:column;gap:8px}
.chat-main{flex:1;display:flex;flex-direction:column;min-width:0;width:100%}
.sidebar-toggle{display:none;position:fixed;top:78px;left:12px;z-index:200;width:36px;height:36px;border-radius:8px;background:rgba(107,44,245,.3);border:1px solid var(--border);color:var(--white);cursor:pointer;align-items:center;justify-content:center;font-size:18px}
.sidebar-overlay{display:none;position:fixed;inset:0;z-index:150;background:rgba(0,0,0,.6);backdrop-filter:blur(4px)}
.new-chat-btn{display:flex;align-items:center;gap:8px;padding:10px 12px;background:linear-gradient(135deg,var(--violet),var(--violet-mid));border:none;border-radius:10px;color:#fff;font-family:'Exo 2',sans-serif;font-size:13px;font-weight:600;cursor:pointer;width:100%;transition:all .2s}
.new-chat-btn:hover{box-shadow:0 4px 20px var(--glow)}
.side-lbl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--muted);padding:8px 4px 4px}
.hist-list{flex:1;overflow-y:auto;padding:0 8px 8px}
.hist-list::-webkit-scrollbar{width:3px}
.hist-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.hist-item{padding:9px 10px;border-radius:8px;font-size:12px;color:var(--muted);cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:all .15s;display:flex;align-items:center;gap:6px}
.hist-item:hover{background:rgba(139,92,246,.1);color:var(--white)}
.hist-item.active{background:rgba(139,92,246,.15);color:var(--white)}
.hist-item-del{margin-left:auto;opacity:0;font-size:11px;color:var(--muted);flex-shrink:0;padding:2px 4px;border-radius:4px}
.hist-item:hover .hist-item-del{opacity:1}
.hist-item-del:hover{color:#f87171;background:rgba(248,113,113,.1)}
.side-bottom{padding:12px 16px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:6px}
.side-sec-lbl{font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:4px}
.model-sel{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:8px;padding:8px 10px;color:var(--white);font-family:'Exo 2',sans-serif;font-size:12px;outline:none;width:100%;cursor:pointer;margin-bottom:6px}
.credits-bar{background:rgba(139,92,246,.08);border:1px solid var(--border);border-radius:8px;padding:10px 12px;font-size:12px}
.credits-bar-label{color:var(--muted);margin-bottom:6px;font-size:11px}
.credits-bar-track{background:rgba(255,255,255,.06);border-radius:4px;height:5px;overflow:hidden}
.credits-bar-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--violet-bright),var(--cyan));transition:width .4s}
.credits-bar-count{color:var(--white);font-weight:700;margin-top:4px;font-size:12px}
.chat-header{padding:14px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:rgba(3,1,10,.7);backdrop-filter:blur(20px);flex-shrink:0}
.chat-title{font-family:'Orbitron',sans-serif;font-size:13px;font-weight:700;letter-spacing:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:300px}
.model-badge{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:20px;padding:5px 12px;font-size:11px;color:var(--muted);flex-shrink:0}
.badge-dot{width:5px;height:5px;border-radius:50%;background:#4ade80;animation:blink 2s infinite}
.msg-area{flex:1;overflow-y:auto;padding:28px 24px;display:flex;flex-direction:column;gap:16px}
.msg-area::-webkit-scrollbar{width:4px}
.msg-area::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.chat-empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;text-align:center;padding:40px}
.empty-orb{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--violet),var(--cyan));display:flex;align-items:center;justify-content:center;font-family:'Orbitron',sans-serif;font-size:18px;font-weight:900;color:#fff;box-shadow:0 0 40px var(--glow);animation:orbP 3s ease-in-out infinite}
.empty-title{font-family:'Orbitron',sans-serif;font-size:18px;font-weight:700}
.empty-sub{font-size:13px;color:var(--muted)}
.suggs{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:8px}
.sugg{background:rgba(139,92,246,.08);border:1px solid var(--border);border-radius:20px;padding:8px 16px;font-size:12px;color:var(--muted);cursor:pointer;transition:all .2s}
.sugg:hover{border-color:var(--violet-bright);color:var(--white);background:rgba(139,92,246,.15)}
.message{display:flex;gap:10px;animation:msgIn .3s ease;max-width:820px}
.message.user{align-self:flex-end;flex-direction:row-reverse}
.message.ai{align-self:flex-start}
@keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.msg-av{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;flex-shrink:0;margin-top:2px;font-family:'Orbitron',sans-serif}
.msg-av.ai{background:linear-gradient(135deg,var(--violet),var(--cyan));box-shadow:0 2px 12px var(--glow)}
.msg-av.user{background:rgba(255,255,255,.07);border:1px solid var(--border);color:var(--violet-bright)}
.msg-bub{padding:11px 15px;border-radius:14px;font-size:14px;line-height:1.7;max-width:calc(100% - 40px)}
.message.ai .msg-bub{background:rgba(11,5,40,.9);border:1px solid var(--border);border-top-left-radius:4px}
.message.user .msg-bub{background:rgba(107,44,245,.2);border:1px solid rgba(139,92,246,.3);border-top-right-radius:4px}
.msg-bub p{margin-bottom:8px}.msg-bub p:last-child{margin-bottom:0}
.msg-bub strong{color:var(--violet-bright)}
.msg-bub code{font-family:'Courier New',monospace;background:rgba(139,92,246,.15);padding:2px 6px;border-radius:4px;font-size:13px;color:#c4b5fd}
.msg-bub pre{background:rgba(0,0,0,.4);border:1px solid var(--border);border-radius:8px;padding:12px;overflow-x:auto;margin:8px 0}
.msg-bub pre code{background:none;padding:0}
.msg-img{max-width:280px;max-height:200px;border-radius:10px;border:1px solid var(--border);margin-bottom:8px;display:block}
.typing{display:flex;gap:4px;align-items:center;padding:4px 0}
.typing span{width:5px;height:5px;background:var(--violet-bright);border-radius:50%;animation:typB 1.2s infinite}
.typing span:nth-child(2){animation-delay:.2s}.typing span:nth-child(3){animation-delay:.4s}
@keyframes typB{0%,60%,100%{transform:translateY(0);opacity:.5}30%{transform:translateY(-6px);opacity:1}}

/* IMAGE PREVIEW */
.img-preview-bar{padding:8px 24px 0;display:none;align-items:center;gap:8px;flex-wrap:wrap}
.img-preview-bar.has-img{display:flex}
.img-thumb{width:52px;height:52px;border-radius:8px;object-fit:cover;border:2px solid var(--violet-bright)}
.img-remove{width:20px;height:20px;border-radius:50%;background:rgba(248,113,113,.2);border:1px solid rgba(248,113,113,.4);color:#f87171;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-left:-14px;margin-top:-14px;align-self:flex-start}

/* INPUT */
.inp-area{padding:10px 24px 16px;background:rgba(3,1,10,.92);border-top:1px solid var(--border);flex-shrink:0}
.inp-wrap{display:flex;gap:8px;align-items:flex-end;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:14px;padding:10px 12px;transition:border-color .2s,box-shadow .2s}
.inp-wrap:focus-within{border-color:var(--violet-bright);box-shadow:0 0 0 3px rgba(139,92,246,.1)}
.inp-icon-btn{width:32px;height:32px;background:transparent;border:none;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:6px;transition:all .2s;flex-shrink:0}
.inp-icon-btn:hover{color:var(--white);background:rgba(139,92,246,.15)}
#chatInput{flex:1;background:transparent;border:none;outline:none;color:var(--white);font-family:'Exo 2',sans-serif;font-size:14px;line-height:1.6;resize:none;max-height:140px;overflow-y:auto;padding:2px 0}
#chatInput::placeholder{color:rgba(128,128,176,.4)}
.send-btn{width:34px;height:34px;background:linear-gradient(135deg,var(--violet),var(--violet-mid));border:none;border-radius:8px;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s}
.send-btn:hover:not(:disabled){transform:scale(1.05);box-shadow:0 4px 16px var(--glow)}
.send-btn:disabled{opacity:.4;cursor:not-allowed}
.inp-hint{font-size:11px;color:rgba(128,128,176,.4);margin-top:6px;padding:0 2px;display:flex;justify-content:space-between}

/* CREDITS MODAL */
.modal-overlay{display:none;position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal-box{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:40px;max-width:400px;width:90%;text-align:center;animation:cardIn .3s ease}
.modal-icon{font-size:48px;margin-bottom:16px}
.modal-title{font-family:'Orbitron',sans-serif;font-size:20px;font-weight:700;margin-bottom:10px}
.modal-text{color:var(--muted);font-size:14px;line-height:1.6;margin-bottom:24px}
.modal-btns{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}

/* SETTINGS PAGE */
#settingsPage{padding-top:70px;min-height:100vh}
.settings-container{max-width:720px;margin:0 auto;padding:40px}
.settings-title{font-family:'Orbitron',sans-serif;font-size:26px;font-weight:900;margin-bottom:8px}
.settings-sub{color:var(--muted);font-size:14px;margin-bottom:40px}
.settings-section{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:28px;margin-bottom:20px}
.settings-section-title{font-family:'Orbitron',sans-serif;font-size:14px;font-weight:700;color:var(--violet-bright);margin-bottom:20px;text-transform:uppercase;letter-spacing:1px;display:flex;align-items:center;gap:8px}
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid rgba(139,92,246,.08)}
.settings-row:last-child{border-bottom:none;padding-bottom:0}
.settings-row-label{font-size:14px;font-weight:500}
.settings-row-sub{font-size:12px;color:var(--muted);margin-top:2px}
.theme-grid{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.theme-btn{width:44px;height:44px;border-radius:10px;border:2px solid transparent;cursor:pointer;transition:all .2s;position:relative}
.theme-btn.active{border-color:var(--white);transform:scale(1.1)}
.theme-btn::after{content:attr(data-label);position:absolute;bottom:-20px;left:50%;transform:translateX(-50%);font-size:10px;color:var(--muted);white-space:nowrap}
.lang-select{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--white);font-family:'Exo 2',sans-serif;font-size:13px;outline:none;cursor:pointer}
.toggle-sw{position:relative;width:44px;height:24px;cursor:pointer}
.toggle-sw input{opacity:0;width:0;height:0}
.toggle-track{position:absolute;inset:0;background:rgba(255,255,255,.1);border-radius:12px;transition:.3s}
.toggle-sw input:checked + .toggle-track{background:var(--violet-mid)}
.toggle-thumb{position:absolute;top:3px;left:3px;width:18px;height:18px;background:#fff;border-radius:50%;transition:.3s}
.toggle-sw input:checked ~ .toggle-thumb{left:23px}
.btn-danger{background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.3);color:#f87171;padding:10px 20px;border-radius:8px;font-family:'Exo 2',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.btn-danger:hover{background:rgba(248,113,113,.2)}

/* MASTER */
#masterPage{padding-top:70px;min-height:100vh}
.master-container{max-width:1200px;margin:0 auto;padding:40px}
.master-header{display:flex;align-items:center;gap:16px;margin-bottom:40px}
.master-title{font-family:'Orbitron',sans-serif;font-size:28px;font-weight:900;background:linear-gradient(135deg,var(--pink),var(--violet-bright));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.master-badge{background:linear-gradient(135deg,rgba(236,72,153,.3),rgba(139,92,246,.3));border:1px solid rgba(236,72,153,.5);border-radius:20px;padding:4px 14px;font-size:12px;font-weight:700;color:#f9a8d4;text-transform:uppercase;letter-spacing:1px}
.master-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:32px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;text-align:center}
.stat-num{font-family:'Orbitron',sans-serif;font-size:28px;font-weight:900;color:var(--white);margin-bottom:4px}
.stat-label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
.users-table{width:100%;border-collapse:collapse}
.users-table th{padding:12px 16px;text-align:left;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);border-bottom:1px solid var(--border)}
.users-table td{padding:13px 16px;border-bottom:1px solid rgba(139,92,246,.07);font-size:13px;vertical-align:middle}
.users-table tr:hover td{background:rgba(139,92,246,.04)}
.btn-role{padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;border:none;transition:all .2s;font-family:'Exo 2',sans-serif}
.btn-role-normal{background:rgba(139,92,246,.2);color:var(--violet-bright)}
.btn-role-tester{background:rgba(6,182,212,.2);color:var(--cyan)}
.btn-role-premium{background:rgba(245,158,11,.2);color:var(--gold)}
.btn-role:hover{filter:brightness(1.3);transform:scale(1.05)}
.user-detail-panel{background:rgba(139,92,246,.05);border:1px solid var(--border);border-radius:12px;padding:20px;margin-top:6px;display:none;animation:cardIn .2s ease}
.user-detail-panel.open{display:block}
.detail-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
.detail-item{background:rgba(255,255,255,.03);border-radius:8px;padding:12px}
.detail-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.detail-value{font-size:14px;font-weight:600}
.online-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:4px}
.online-dot.on{background:#4ade80;box-shadow:0 0 6px #4ade80}
.online-dot.off{background:var(--muted)}

/* TOAST */
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(20px);background:rgba(30,10,60,.97);border:1px solid rgba(236,72,153,.3);color:#f9a8d4;padding:10px 20px;border-radius:10px;font-size:13px;opacity:0;transition:all .3s;pointer-events:none;z-index:9999;max-width:440px;text-align:center;backdrop-filter:blur(20px)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.success{border-color:rgba(6,182,212,.4);color:#67e8f9}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;margin-right:6px}
.reveal{opacity:0;transform:translateY(30px);transition:opacity .6s ease,transform .6s ease}
.reveal.visible{opacity:1;transform:translateY(0)}

@media(max-width:768px){
  .about-grid,.contact-grid{grid-template-columns:1fr}
  .services-grid,.pricing-grid,.master-stats{grid-template-columns:1fr}
  .navbar{padding:0 16px}.nav-links{display:none}
  .chat-side{position:fixed;left:0;top:70px;bottom:0;z-index:160;transform:translateX(-100%);width:260px!important}
  .chat-side.open{transform:translateX(0)}
  .sidebar-toggle{display:flex}
  .sidebar-overlay.open{display:block}
  .chat-header,.msg-area,.inp-area,.img-preview-bar{padding-left:16px;padding-right:16px}
  .detail-grid{grid-template-columns:1fr 1fr}
  .settings-container,.master-container{padding:20px}
}
</style>
</head>
<body>

<canvas id="spaceCanvas"></canvas>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
<button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">‚ò∞</button>
<input type="file" id="imgFileInput" accept="image/*" style="display:none" onchange="handleImgSelect(event)">

<!-- NAVBAR -->
<nav class="navbar" id="navbar" style="display:none">
  <div class="nav-logo" onclick="goHome()">NEXUS</div>
  <ul class="nav-links">
    <li><a onclick="goSec('about')">√Ä propos</a></li>
    <li><a onclick="goSec('services')">Services</a></li>
    <li><a onclick="goChat()">IA Chat</a></li>
    <li><a onclick="showPage('pricing')">Premium</a></li>
    <li><a id="masterNavLink" onclick="showPage('master')" style="display:none;color:#f9a8d4">‚ö° Master</a></li>
  </ul>
  <div class="nav-right">
    <div id="navUserArea">
      <div class="credits-display">‚ö° <span id="navCredits">‚Äî</span></div>
      <span id="navUserName" onclick="showPage('settings')" title="Param√®tres"></span>
      <span id="navRoleBadge" class="role-badge role-normal">Normal</span>
      <button class="btn-nav btn-outline" onclick="showPage('settings')" title="Param√®tres">‚öôÔ∏è</button>
      <button class="btn-nav btn-outline" onclick="doLogout()">D√©connexion</button>
    </div>
    <div id="navAuthArea">
      <button class="btn-nav btn-outline" onclick="showPage('login')">Connexion</button>
      <button class="btn-nav btn-primary" onclick="showPage('register')">Commencer</button>
    </div>
  </div>
</nav>

<!-- LOGIN -->
<div class="page" id="loginPage">
  <div class="auth-page"><div class="auth-card">
    <div class="auth-logo">NEXUS</div>
    <p class="auth-sub">Bienvenue ‚Äî Connectez-vous</p>
    <div class="auth-err" id="loginErr"></div>
    <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="loginEmail" placeholder="vous@example.com"/></div>
    <div class="form-group"><label class="form-label">Mot de passe</label><input type="password" class="form-input" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()"/></div>
    <button class="btn-full" id="loginBtn" onclick="doLogin()">Se connecter</button>
    <p class="auth-switch">Pas encore de compte ? <a onclick="showPage('register')">S'inscrire</a></p>
  </div></div>
</div>

<!-- REGISTER -->
<div class="page" id="registerPage">
  <div class="auth-page"><div class="auth-card">
    <div class="auth-logo">NEXUS</div>
    <p class="auth-sub">Cr√©ez votre compte</p>
    <div class="auth-err" id="registerErr"></div>
    <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="regEmail" placeholder="vous@example.com"/></div>
    <div class="form-group"><label class="form-label">Mot de passe</label><input type="password" class="form-input" id="regPass" placeholder="6 caract√®res minimum"/></div>
    <div class="form-group"><label class="form-label">Confirmer</label><input type="password" class="form-input" id="regConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doRegister()"/></div>
    <button class="btn-full" id="registerBtn" onclick="doRegister()">Cr√©er mon compte</button>
    <p class="auth-switch">D√©j√† un compte ? <a onclick="showPage('login')">Se connecter</a></p>
  </div></div>
</div>

<!-- VERIFY -->
<div class="page" id="verifyPage">
  <div class="auth-page"><div class="auth-card verif-card">
    <div class="verif-icon">‚úâÔ∏è</div>
    <div class="verif-title">V√©rifiez votre email</div>
    <p class="verif-text">Un lien a √©t√© envoy√© √† :</p>
    <div class="verif-email" id="verifyEmail">‚Äî</div>
    <p class="verif-text">Cliquez sur le lien puis connectez-vous.</p>
    <button class="btn-full" onclick="showPage('login')">Aller √† la connexion ‚Üí</button>
    <br><button class="btn-ghost" onclick="resendVerif()">Renvoyer l'email</button>
  </div></div>
</div>

<!-- HOME -->
<div class="page" id="homePage" style="padding-top:70px">
  <section class="hero">
    <div class="hero-content">
      <div class="hero-badge">Nouvelle g√©n√©ration d'IA</div>
      <h1 class="hero-title">Bienvenue sur<br><span>NEXUS</span></h1>
      <p class="hero-sub">Une plateforme IA puissante construite pour le futur. Propuls√©e par les meilleurs mod√®les du monde.</p>
      <div class="hero-ctas">
        <button class="btn-hp" onclick="goChat()">Commencer maintenant</button>
        <button class="btn-hs" onclick="showPage('pricing')">Voir les offres</button>
      </div>
    </div>
  </section>
  <div class="section" id="about">
    <div class="section-label">√Ä propos</div>
    <h2 class="section-title">Nexus ‚Äî L'IA <span style="background:linear-gradient(135deg,#8b5cf6,#06b6d4);-webkit-background-clip:text;-webkit-text-fill-color:transparent">au service</span> de votre vision</h2>
    <p class="section-desc">Con√ßu pour les cr√©ateurs, entrepreneurs et d√©veloppeurs qui veulent aller plus loin.</p>
    <div class="about-grid reveal">
      <div class="about-visual"><div class="orbit-ring ring-1"><div class="orbit-dot"></div></div><div class="orbit-ring ring-2"></div><div class="about-orb">NX</div></div>
      <div class="about-features">
        <div class="about-feat"><div class="feat-icon">ü§ñ</div><div class="feat-text"><h4>IA Powered</h4><p>GPT-4, Claude, Llama et plus via OpenRouter.</p></div></div>
        <div class="about-feat"><div class="feat-icon">üñºÔ∏è</div><div class="feat-text"><h4>Vision IA</h4><p>Envoyez des photos √† l'IA pour des analyses visuelles.</p></div></div>
        <div class="about-feat"><div class="feat-icon">üîí</div><div class="feat-text"><h4>S√©curis√©</h4><p>Auth Supabase, chiffrement total, vie priv√©e garantie.</p></div></div>
      </div>
    </div>
  </div>
  <div style="padding:0 0 100px;position:relative;z-index:1" id="services">
    <div class="section" style="padding-top:0">
      <div class="section-label">Services</div>
      <h2 class="section-title">Ce que <span style="background:linear-gradient(135deg,#8b5cf6,#ec4899);-webkit-background-clip:text;-webkit-text-fill-color:transparent">Nexus</span> vous offre</h2>
      <p class="section-desc">Des outils puissants pour transformer vos id√©es en r√©alit√©.</p>
      <div class="services-grid reveal">
        <div class="svc-card"><div class="svc-icon">üåê</div><div class="svc-title">Cr√©ation Web</div><p class="svc-desc">G√©n√©rez des sites web complets gr√¢ce √† l'IA.</p><button class="btn-svc" onclick="goChat()">Essayer</button></div>
        <div class="svc-card"><div class="svc-icon">üì£</div><div class="svc-title">Marketing Digital</div><p class="svc-desc">Contenus percutants et campagnes optimis√©es par l'IA.</p><button class="btn-svc" onclick="goChat()">Essayer</button></div>
        <div class="svc-card"><div class="svc-icon">üîç</div><div class="svc-title">SEO Optimization</div><p class="svc-desc">Am√©liorez votre visibilit√© avec des recommandations IA.</p><button class="btn-svc" onclick="goChat()">Essayer</button></div>
      </div>
    </div>
  </div>
  <div style="padding:0 0 100px;position:relative;z-index:1" id="contact">
    <div class="section" style="padding-top:0">
      <div class="section-label">Contact</div>
      <h2 class="section-title">Parlons de votre <span style="background:linear-gradient(135deg,#06b6d4,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent">projet</span></h2>
      <p class="section-desc">Notre √©quipe vous r√©pond rapidement.</p>
      <div class="contact-grid reveal">
        <div class="contact-info">
          <div class="contact-item"><div class="contact-icon">üìû</div><div class="contact-detail"><h5>T√©l√©phone</h5><p>012-345-6789</p></div></div>
          <div class="contact-item"><div class="contact-icon">‚úâÔ∏è</div><div class="contact-detail"><h5>Email</h5><p>info@nexus-ai.com</p></div></div>
          <div class="contact-item"><div class="contact-icon">üìç</div><div class="contact-detail"><h5>Adresse</h5><p>123 Avenue de l'Innovation, Paris</p></div></div>
        </div>
        <div class="contact-form">
          <div class="contact-form-title">Envoyer un message</div>
          <div class="form-group"><label class="form-label">Nom</label><input type="text" class="form-input" id="cName" placeholder="Votre nom"/></div>
          <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="cEmail" placeholder="votre@email.com"/></div>
          <div class="form-group"><label class="form-label">Message</label><textarea class="form-input" rows="4" id="cMsg" style="resize:vertical" placeholder="D√©crivez votre projet..."></textarea></div>
          <button class="btn-full" onclick="sendContact()">Envoyer</button>
        </div>
      </div>
    </div>
  </div>
  <footer class="footer"><div class="footer-inner">
    <div><div class="footer-logo">NEXUS</div><p class="footer-text">¬© 2025 Nexus AI.</p></div>
    <div class="footer-socials"><div class="soc-btn">f</div><div class="soc-btn">ùïè</div><div class="soc-btn">‚úâ</div></div>
  </div></footer>
</div>

<!-- PRICING -->
<div class="page" id="pricingPage">
  <div class="pricing-hero">
    <div class="section-label">Abonnements</div>
    <h2 class="section-title">Choisissez votre <span style="background:linear-gradient(135deg,#f59e0b,#ec4899);-webkit-background-clip:text;-webkit-text-fill-color:transparent">plan</span></h2>
    <p class="section-desc">Plus de cr√©dits et des fonctionnalit√©s exclusives.</p>
  </div>
  <div class="pricing-grid">
    <div class="pricing-card">
      <div class="plan-icon">üë§</div><div class="plan-name">Normal</div>
      <div class="plan-price">0<span>‚Ç¨</span></div><div class="plan-alt">Gratuit pour toujours</div>
      <ul class="plan-features"><li>60 cr√©dits/jour</li><li>Tous les mod√®les IA</li><li>Envoi de photos</li><li>Historique local</li></ul>
      <button class="btn-plan btn-plan-outline" onclick="goChat()">Commencer</button>
    </div>
    <div class="pricing-card popular">
      <div class="popular-badge">‚≠ê Populaire</div>
      <div class="plan-icon">üöÄ</div><div class="plan-name" style="color:var(--gold)">Premium</div>
      <div class="plan-price" style="color:var(--gold)">6,99<span>‚Ç¨/mois</span></div><div class="plan-alt">ou 49‚Ç¨/an ‚Äî √©conomisez 35%</div>
      <ul class="plan-features"><li>Cr√©dits illimit√©s</li><li>Tous les mod√®les IA</li><li>R√©ponses prioritaires</li><li>Support premium</li><li>Acc√®s anticip√©</li></ul>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn-plan btn-plan-gold" onclick="paypalPay('monthly')">üí≥ 6,99‚Ç¨/mois</button>
        <button class="btn-plan btn-plan-gold" style="opacity:.85" onclick="paypalPay('yearly')">üí≥ 49‚Ç¨/an</button>
      </div>
    </div>
    <div class="pricing-card">
      <div class="plan-icon">üß™</div><div class="plan-name" style="color:var(--cyan)">Testeur</div>
      <div class="plan-price" style="color:var(--cyan)">‚Äî</div><div class="plan-alt">Sur invitation</div>
      <ul class="plan-features"><li>120 cr√©dits/jour</li><li>Acc√®s b√™ta</li><li>Tous les mod√®les IA</li><li>Canal testeurs</li></ul>
      <button class="btn-plan btn-plan-outline" style="opacity:.5;cursor:not-allowed">Sur invitation</button>
    </div>
  </div>
  <div style="text-align:center;padding-bottom:60px"><button class="btn-ghost" onclick="goHome()">‚Üê Retour</button></div>
</div>

<!-- CHAT -->
<div class="page" id="chatPage">
  <div class="chat-container">
    <div class="chat-side" id="chatSidebar">
      <div class="chat-side-top">
        <button class="new-chat-btn" onclick="newChat()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Nouvelle conversation
        </button>
        <div class="side-lbl">Historique</div>
      </div>
      <div class="hist-list" id="histList"></div>
      <div class="side-bottom">
        <div class="side-sec-lbl">Mod√®le IA</div>
        <select class="model-sel" id="modelSel" onchange="updateBadge()">
          <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
          <option value="openai/gpt-4o">GPT-4o (Vision)</option>
          <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
          <option value="anthropic/claude-3-haiku">Claude 3 Haiku</option>
          <option value="meta-llama/llama-3.1-8b-instruct">Llama 3.1 8B</option>
          <option value="google/gemini-flash-1.5">Gemini Flash 1.5</option>
        </select>
        <div class="credits-bar">
          <div class="credits-bar-label">Cr√©dits aujourd'hui</div>
          <div class="credits-bar-track"><div class="credits-bar-fill" id="creditsBarFill" style="width:100%"></div></div>
          <div class="credits-bar-count"><span id="creditsLeft">‚Äî</span> / <span id="creditsMax">‚Äî</span></div>
        </div>
        <button class="btn-ghost" style="width:100%;text-align:center;font-size:12px;margin-top:4px" onclick="showPage('pricing')">‚≠ê Passer Premium</button>
      </div>
    </div>
    <div class="chat-main">
      <div class="chat-header">
        <span class="chat-title" id="chatTitle">NEXUS IA</span>
        <div class="model-badge"><div class="badge-dot"></div><span id="badgeModel">GPT-4o Mini</span></div>
      </div>
      <div class="msg-area" id="msgArea">
        <div class="chat-empty-state" id="chatEmpty">
          <div class="empty-orb">NX</div>
          <div class="empty-title">Nexus IA est pr√™t</div>
          <div class="empty-sub">Choisissez un mod√®le et commencez √† √©crire</div>
          <div class="suggs">
            <div class="sugg" onclick="useSugg(this)">‚úçÔ∏è R√©dige un email professionnel</div>
            <div class="sugg" onclick="useSugg(this)">üíª Aide-moi √† coder en Python</div>
            <div class="sugg" onclick="useSugg(this)">üí° Explique le machine learning</div>
            <div class="sugg" onclick="useSugg(this)">üéØ Cr√©e une strat√©gie marketing</div>
          </div>
        </div>
      </div>
      <div class="img-preview-bar" id="imgPreviewBar"></div>
      <div class="inp-area">
        <div class="inp-wrap">
          <button class="inp-icon-btn" onclick="document.getElementById('imgFileInput').click()" title="Ajouter une image">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
          </button>
          <textarea id="chatInput" placeholder="√âcrivez votre message..." rows="1" onkeydown="onKey(event)" oninput="resizeInp(this)"></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMsg()">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
        <div class="inp-hint"><span>Entr√©e pour envoyer ¬∑ Maj+Entr√©e nouvelle ligne</span><span id="hintCredits" style="color:var(--muted)"></span></div>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS -->
<div class="page" id="settingsPage">
  <div class="settings-container">
    <div class="settings-title">‚öôÔ∏è Param√®tres</div>
    <div class="settings-sub">Personnalisez votre exp√©rience Nexus</div>

    <!-- Profil -->
    <div class="settings-section">
      <div class="settings-section-title">üë§ Profil</div>
      <div class="form-group"><label class="form-label">Pseudo</label><input type="text" class="form-input" id="settingsPseudo" placeholder="Votre pseudo"/></div>
      <div class="form-group"><label class="form-label">Email (lecture seule)</label><input type="text" class="form-input" id="settingsEmail" placeholder="‚Äî" readonly style="opacity:.6"/></div>
      <button class="btn-full" style="margin-top:0" onclick="savePseudo()">Sauvegarder le pseudo</button>
    </div>

    <!-- S√©curit√© -->
    <div class="settings-section">
      <div class="settings-section-title">üîí S√©curit√©</div>
      <div class="form-group"><label class="form-label">Nouveau mot de passe</label><input type="password" class="form-input" id="newPass" placeholder="6 caract√®res minimum"/></div>
      <div class="form-group"><label class="form-label">Confirmer</label><input type="password" class="form-input" id="confPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
      <button class="btn-full" style="margin-top:0" onclick="changePass()">Changer le mot de passe</button>
    </div>

    <!-- Apparence -->
    <div class="settings-section">
      <div class="settings-section-title">üé® Apparence</div>
      <div class="settings-row">
        <div><div class="settings-row-label">Th√®me de couleur</div><div class="settings-row-sub">Choisissez la couleur principale</div></div>
      </div>
      <div class="theme-grid" style="margin-top:16px">
        <div class="theme-btn active" data-theme="" data-label="Violet" style="background:linear-gradient(135deg,#4b0fd4,#8b5cf6)" onclick="setTheme(this,'')"></div>
        <div class="theme-btn" data-theme="blue" data-label="Bleu" style="background:linear-gradient(135deg,#0ea5e9,#38bdf8)" onclick="setTheme(this,'blue')"></div>
        <div class="theme-btn" data-theme="green" data-label="Vert" style="background:linear-gradient(135deg,#059669,#34d399)" onclick="setTheme(this,'green')"></div>
        <div class="theme-btn" data-theme="pink" data-label="Rose" style="background:linear-gradient(135deg,#db2777,#f472b6)" onclick="setTheme(this,'pink')"></div>
      </div>
    </div>

    <!-- Langue -->
    <div class="settings-section">
      <div class="settings-section-title">üåê Langue</div>
      <div class="settings-row">
        <div><div class="settings-row-label">Langue de l'interface</div></div>
        <select class="lang-select" id="langSelect" onchange="setLang(this.value)">
          <option value="fr">üá´üá∑ Fran√ßais</option>
          <option value="en">üá¨üáß English</option>
        </select>
      </div>
    </div>

    <!-- Danger -->
    <div class="settings-section" style="border-color:rgba(248,113,113,.2)">
      <div class="settings-section-title" style="color:#f87171">‚ö†Ô∏è Zone de danger</div>
      <div class="settings-row">
        <div><div class="settings-row-label">Supprimer mon compte</div><div class="settings-row-sub">Action irr√©versible ‚Äî toutes vos donn√©es seront supprim√©es</div></div>
        <button class="btn-danger" onclick="deleteAccount()">Supprimer</button>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:10px">
      <button class="btn-ghost" onclick="goHome()">‚Üê Retour</button>
    </div>
  </div>
</div>

<!-- MASTER -->
<div class="page" id="masterPage">
  <div class="master-container">
    <div class="master-header">
      <div><div class="master-title">‚ö° MASTER DASHBOARD</div><div style="color:var(--muted);font-size:13px;margin-top:4px">Panneau cr√©ateur ‚Äî Acc√®s exclusif</div></div>
      <div class="master-badge">CR√âATEUR</div>
    </div>
    <div class="master-stats">
      <div class="stat-card"><div class="stat-num" id="statTotal">‚Äî</div><div class="stat-label">Utilisateurs</div></div>
      <div class="stat-card"><div class="stat-num" id="statOnline" style="color:#4ade80">‚Äî</div><div class="stat-label">Actifs 24h</div></div>
      <div class="stat-card"><div class="stat-num" id="statPremium" style="color:var(--gold)">‚Äî</div><div class="stat-label">Premium</div></div>
      <div class="stat-card"><div class="stat-num" id="statTesters" style="color:var(--cyan)">‚Äî</div><div class="stat-label">Testeurs</div></div>
    </div>
    <div style="font-family:'Orbitron',sans-serif;font-size:15px;font-weight:700;margin-bottom:16px">üë• Utilisateurs</div>
    <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:auto">
      <table class="users-table">
        <thead><tr><th>Email</th><th>Pseudo</th><th>R√¥le</th><th>Cr√©dits</th><th>Inscrit</th><th>Statut</th><th>Actions</th></tr></thead>
        <tbody id="usersTableBody"><tr><td colspan="7" style="text-align:center;color:var(--muted);padding:32px">Chargement...</td></tr></tbody>
      </table>
    </div>
    <!-- SECTION CL√â API -->
    <div style="background:var(--card);border:1px solid rgba(245,158,11,.3);border-radius:16px;padding:28px;margin-top:24px">
      <div style="font-family:'Orbitron',sans-serif;font-size:14px;font-weight:700;color:var(--gold);margin-bottom:16px;display:flex;align-items:center;gap:8px">üîë Cl√© API OpenRouter</div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:16px">La cl√© est stock√©e localement sur cet appareil. Seul toi (Cr√©ateur) peux la modifier.</div>
      <div style="display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:10px;padding:12px 16px" id="apiKeyDisplay">
        <span style="font-size:13px;color:var(--muted);flex:1" id="apiKeyMasked">Chargement...</span>
        <button class="btn-role" style="background:rgba(245,158,11,.2);color:var(--gold);font-size:12px;padding:6px 14px" onclick="editApiKey()">‚úèÔ∏è Modifier</button>
      </div>
      <div id="apiKeyEditArea" style="display:none;margin-top:12px">
        <div style="display:flex;gap:8px;align-items:center">
          <input type="password" id="apiKeyInput" class="form-input" placeholder="sk-or-v1-..." style="flex:1;margin:0"/>
          <button class="btn-role btn-role-premium" style="padding:10px 16px;font-size:13px" onclick="saveApiKey()">‚úÖ Sauvegarder</button>
          <button class="btn-ghost" style="padding:10px 14px;margin:0" onclick="cancelApiKey()">‚úï</button>
        </div>
        <div id="apiKeyStatus" style="font-size:12px;margin-top:8px;color:var(--muted)"></div>
      </div>
    </div>

    <div style="margin-top:20px;display:flex;gap:8px">
      <button class="btn-ghost" onclick="loadMasterData()">üîÑ Actualiser</button>
      <button class="btn-ghost" onclick="goHome()">‚Üê Retour</button>
    </div>
  </div>
</div>

<!-- CREDITS MODAL -->
<div class="modal-overlay" id="creditsModal">
  <div class="modal-box">
    <div class="modal-icon">‚ö°</div>
    <div class="modal-title">Cr√©dits √©puis√©s</div>
    <div class="modal-text" id="creditsModalText">Vous avez utilis√© tous vos cr√©dits pour aujourd'hui.</div>
    <div class="modal-btns">
      <button class="btn-full" style="margin-top:0" onclick="showPage('pricing');closeModal()">‚≠ê Voir les offres</button>
      <button class="btn-ghost" onclick="closeModal()">Fermer</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë  üîß CONFIGURATION ‚Äî √Ä modifier              ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
var SUPABASE_URL = "https://ddebrzazzbsihtrrzuel.supabase.co";
var SUPABASE_KEY = "sb_publishable_B5IyGY0fiLx6AGTvgP1tVg_MrDkpCyE";
var OR_KEY = localStorage.getItem("nx_api_key") || "";
var CREATOR_EMAIL = "louistou07@gmail.com";

// ‚îÄ‚îÄ R√îLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var ROLES = {
  normal:  {label:'Normal',  credits:60,     cls:'role-normal'},
  tester:  {label:'Testeur', credits:120,    cls:'role-tester'},
  premium: {label:'Premium', credits:999999, cls:'role-premium'},
  creator: {label:'Cr√©ateur',credits:999999, cls:'role-creator'}
};

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var sb=null, sbOK=false;
var currentUser=null, userProfile=null;
var pendingEmail='';
var pendingImages=[];  // [{base64, type, thumb}]
var conversations={}; // {id: {title, msgs}}
var activeConvId=null;

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initSupabase(){
  if(SUPABASE_URL==='VOTRE_URL_ICI')return;
  try{
    sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
    sbOK=true;
    sb.auth.getSession().then(function(r){
      if(r.data&&r.data.session){currentUser=r.data.session.user;loadProfile().then(function(){showPage('home');});}
    });
    sb.auth.onAuthStateChange(function(ev,sess){
      if(ev==='SIGNED_IN'&&sess){currentUser=sess.user;loadProfile().then(function(){if(currentUser.email_confirmed_at)showPage('home');});}
      else if(ev==='SIGNED_OUT'){currentUser=null;userProfile=null;}
    });
  }catch(e){console.error(e);}
}

async function loadProfile(){
  if(!sb||!currentUser)return;
  if(currentUser.email===CREATOR_EMAIL){
    userProfile={role:'creator',credits_used:0,credits_reset_date:today(),pseudo:''};
    await upsertProfile();
  }else{
    var r=await sb.from('profiles').select('*').eq('id',currentUser.id).single();
    if(r.error||!r.data){userProfile={role:'normal',credits_used:0,credits_reset_date:today(),pseudo:''};await upsertProfile();}
    else{
      userProfile=r.data;
      if(userProfile.credits_reset_date!==today()){userProfile.credits_used=0;userProfile.credits_reset_date=today();await upsertProfile();}
    }
  }
  loadTheme();
  updateUI();
}

async function upsertProfile(){
  if(!sb||!currentUser||!userProfile)return;
  await sb.from('profiles').upsert({id:currentUser.id,email:currentUser.email,role:userProfile.role,credits_used:userProfile.credits_used,credits_reset_date:userProfile.credits_reset_date,last_seen:new Date().toISOString(),pseudo:userProfile.pseudo||''});
}

function today(){return new Date().toISOString().slice(0,10);}
function getMax(){return userProfile?(ROLES[userProfile.role]||ROLES.normal).credits:60;}
function getLeft(){var m=getMax();if(m>=999999)return 999999;return Math.max(0,m-(userProfile?userProfile.credits_used||0:0));}
async function useCredit(){if(!userProfile)return true;var m=getMax();if(m>=999999)return true;if((userProfile.credits_used||0)>=m)return false;userProfile.credits_used=(userProfile.credits_used||0)+1;await upsertProfile();updateCreditsUI();return true;}

// ‚îÄ‚îÄ UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateUI(){
  if(!currentUser||!userProfile)return;
  var r=userProfile.role||'normal';
  var ri=ROLES[r]||ROLES.normal;
  var pseudo=userProfile.pseudo||localStorage.getItem('nx_pseudo')||currentUser.email.split('@')[0];
  if(!userProfile.pseudo && localStorage.getItem('nx_pseudo')) userProfile.pseudo=localStorage.getItem('nx_pseudo');
  document.getElementById('navUserName').textContent=pseudo;
  var b=document.getElementById('navRoleBadge');b.textContent=ri.label;b.className='role-badge '+ri.cls;
  document.getElementById('masterNavLink').style.display=r==='creator'?'inline':'none';
  updateCreditsUI();
  // Settings
  document.getElementById('settingsPseudo').value=pseudo;
  document.getElementById('settingsEmail').value=currentUser.email||'';
  // Theme
  loadTheme();
}

function updateCreditsUI(){
  if(!userProfile)return;
  var left=getLeft(),max=getMax();
  document.getElementById('creditsLeft').textContent=max>=999999?'‚àû':left;
  document.getElementById('creditsMax').textContent=max>=999999?'‚àû':max;
  document.getElementById('navCredits').textContent=max>=999999?'‚àû':left+'/'+max;
  var pct=max>=999999?100:Math.max(5,(left/max)*100);
  var fill=document.getElementById('creditsBarFill');
  fill.style.width=pct+'%';
  fill.style.background=pct<20?'linear-gradient(90deg,#f87171,#ef4444)':'linear-gradient(90deg,var(--violet-bright),var(--cyan))';
  document.getElementById('hintCredits').textContent=max>=999999?'‚àû cr√©dits':left+' cr√©dits restants';
}

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(name){
  document.querySelectorAll('.page').forEach(function(p){p.style.display='none';});
  var pg=document.getElementById(name+'Page');if(!pg)return;
  pg.style.display=name==='chat'?'flex':'block';
  window.scrollTo(0,0);
  var nb=document.getElementById('navbar');
  var na=document.getElementById('navAuthArea');
  var nu=document.getElementById('navUserArea');
  if(['home','chat','pricing','master','settings'].indexOf(name)>=0){
    nb.style.display='flex';
    if(currentUser&&userProfile){na.style.display='none';nu.style.display='flex';}
    else{na.style.display='flex';nu.style.display='none';}
  }else{nb.style.display='none';}
  if(name==='home')setTimeout(initReveal,150);
  if(name==='settings'){loadLang();}
  if(name==='master'){if(!userProfile||userProfile.role!=='creator'){showPage('home');return;}loadMasterData();setTimeout(loadApiKeyDisplay,100);}
  if(name==='chat'){updateCreditsUI();loadHistoryList();}
}
function goHome(){if(sbOK&&!currentUser){showPage('login');return;}showPage('home');}
function goChat(){if(sbOK&&!currentUser){showPage('login');return;}showPage('chat');}
function goSec(id){goHome();setTimeout(function(){var el=document.getElementById(id);if(el)el.scrollIntoView({behavior:'smooth'});},200);}
function toggleSidebar(){document.getElementById('chatSidebar').classList.toggle('open');document.getElementById('sidebarOverlay').classList.toggle('open');}
function closeSidebar(){document.getElementById('chatSidebar').classList.remove('open');document.getElementById('sidebarOverlay').classList.remove('open');}

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showErr(id,msg){var e=document.getElementById(id);e.textContent=msg;e.style.display='block';}
function hideEl(id){document.getElementById(id).style.display='none';}
function setBtn(id,loading,label){var b=document.getElementById(id);b.disabled=loading;b.innerHTML=loading?'<span class="spinner"></span>'+label:label;}
function sbErr(m){var map={'Invalid login credentials':'Email ou mot de passe incorrect.','Email not confirmed':'Confirmez votre email.','User already registered':'Email d√©j√† utilis√©.','Password should be at least 6 characters':'Mot de passe trop court.'};for(var k in map){if(m&&m.includes(k))return map[k];}return m||'Erreur inconnue.';}

function doLogin(){
  hideEl('loginErr');
  var email=document.getElementById('loginEmail').value.trim();
  var pass=document.getElementById('loginPass').value;
  if(!email||!pass){showErr('loginErr','Remplissez tous les champs.');return;}
  if(!sbOK){showErr('loginErr','‚ö†Ô∏è Supabase non configur√©. Remplis SUPABASE_URL et SUPABASE_KEY dans le script.');return;}
  setBtn('loginBtn',true,'Connexion...');
  sb.auth.signInWithPassword({email:email,password:pass}).then(function(r){
    if(r.error){showErr('loginErr',sbErr(r.error.message));return;}
    currentUser=r.data.user;return loadProfile();
  }).then(function(){if(currentUser){showPage('home');toast('Bienvenue üöÄ','success');}})
  .catch(function(e){showErr('loginErr',sbErr(e.message));})
  .finally(function(){setBtn('loginBtn',false,'Se connecter');});
}

function doRegister(){
  hideEl('registerErr');
  var email=document.getElementById('regEmail').value.trim();
  var pass=document.getElementById('regPass').value;
  var conf=document.getElementById('regConfirm').value;
  if(!email||!pass||!conf){showErr('registerErr','Remplissez tous les champs.');return;}
  if(pass!==conf){showErr('registerErr','Mots de passe diff√©rents.');return;}
  if(pass.length<6){showErr('registerErr','Mot de passe trop court.');return;}
  if(!sbOK){showErr('registerErr','‚ö†Ô∏è Supabase non configur√©.');return;}
  setBtn('registerBtn',true,'Cr√©ation...');
  sb.auth.signUp({email:email,password:pass}).then(function(r){
    if(r.error){showErr('registerErr',sbErr(r.error.message));return;}
    pendingEmail=email;document.getElementById('verifyEmail').textContent=email;
    showPage('verify');toast('Compte cr√©√© ! V√©rifiez votre email üìß','success');
  }).catch(function(e){showErr('registerErr',sbErr(e.message));})
  .finally(function(){setBtn('registerBtn',false,'Cr√©er mon compte');});
}

function resendVerif(){if(!sb||!pendingEmail)return;sb.auth.resend({type:'signup',email:pendingEmail}).then(function(r){if(r.error)toast('Erreur: '+r.error.message);else toast('Email renvoy√© üìß','success');});}
function doLogout(){if(sb)sb.auth.signOut();currentUser=null;userProfile=null;showPage('login');toast('D√©connexion r√©ussie.');}

// ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function savePseudo(){
  var pseudo=document.getElementById('settingsPseudo').value.trim();
  if(!pseudo){toast('Entrez un pseudo.');return;}
  userProfile.pseudo=pseudo;
  localStorage.setItem('nx_pseudo',pseudo);
  await upsertProfile();
  document.getElementById('navUserName').textContent=pseudo;
  document.getElementById('settingsPseudo').value=pseudo;
  toast('Pseudo sauvegard√© ‚úì','success');
}

async function changePass(){
  var np=document.getElementById('newPass').value;
  var cp=document.getElementById('confPass').value;
  if(!np||!cp){toast('Remplissez les deux champs.');return;}
  if(np!==cp){toast('Les mots de passe ne correspondent pas.');return;}
  if(np.length<6){toast('Mot de passe trop court (6 min).');return;}
  if(!sb){toast('Supabase non configur√©.');return;}
  var r=await sb.auth.updateUser({password:np});
  if(r.error)toast('Erreur: '+r.error.message);
  else{toast('Mot de passe chang√© ‚úì','success');document.getElementById('newPass').value='';document.getElementById('confPass').value='';}
}

function setTheme(btn,theme){
  document.querySelectorAll('.theme-btn').forEach(function(b){b.classList.remove('active');});
  btn.classList.add('active');
  // Supprimer les anciens themes sans toucher aux autres classes
  document.body.classList.remove('theme-blue','theme-green','theme-pink');
  if(theme) document.body.classList.add('theme-'+theme);
  localStorage.setItem('nx_theme',theme||'');
  toast('Th√®me appliqu√© ‚úì','success');
}

function loadTheme(){
  var t=localStorage.getItem('nx_theme')||'';
  document.body.classList.remove('theme-blue','theme-green','theme-pink');
  if(t) document.body.classList.add('theme-'+t);
  document.querySelectorAll('.theme-btn').forEach(function(b){
    b.classList.toggle('active',(b.dataset.theme||'')===(t||''));
  });
}

var LANG_FR = {
  chatPlaceholder: '√âcrivez votre message...',
  newChat: 'Nouvelle conversation',
  histTitle: 'Historique',
  emptyTitle: 'Nexus IA est pr√™t',
  emptySub: 'Choisissez un mod√®le et commencez √† √©crire',
  sendHint: 'Entr√©e pour envoyer ¬∑ Maj+Entr√©e nouvelle ligne',
  credits: 'Cr√©dits aujourd'hui',
  modelLabel: 'Mod√®le IA',
  settingsTitle: 'Param√®tres',
  savePseudo: 'Sauvegarder le pseudo',
  changePass: 'Changer le mot de passe',
  logout: 'D√©connexion',
  premium: '‚≠ê Passer Premium'
};
var LANG_EN = {
  chatPlaceholder: 'Write your message...',
  newChat: 'New conversation',
  histTitle: 'History',
  emptyTitle: 'Nexus AI is ready',
  emptySub: 'Choose a model and start writing',
  sendHint: 'Enter to send ¬∑ Shift+Enter new line',
  credits: 'Credits today',
  modelLabel: 'AI Model',
  settingsTitle: 'Settings',
  savePseudo: 'Save username',
  changePass: 'Change password',
  logout: 'Logout',
  premium: '‚≠ê Go Premium'
};

function setLang(lang){
  localStorage.setItem('nx_lang',lang);
  applyLang(lang);
  toast(lang==='en'?'Language set to English ‚úì':'Langue d√©finie en Fran√ßais ‚úì','success');
}

function applyLang(lang){
  var L = lang==='en' ? LANG_EN : LANG_FR;
  var sel = document.getElementById('langSelect');
  if(sel) sel.value = lang;
  var inp = document.getElementById('chatInput');
  if(inp) inp.placeholder = L.chatPlaceholder;
  // Boutons navbar
  var logout = document.querySelector('#navUserArea .btn-outline:last-child');
  if(logout) logout.textContent = L.logout;
  // Sidebar
  var newChatBtn = document.querySelector('.new-chat-btn');
  if(newChatBtn) newChatBtn.childNodes[newChatBtn.childNodes.length-1].textContent = ' '+L.newChat;
  var sideLbl = document.querySelector('.side-lbl');
  if(sideLbl) sideLbl.textContent = L.histTitle;
  // Credits label
  var credLbl = document.querySelector('.credits-bar-label');
  if(credLbl) credLbl.textContent = L.credits;
  // Hint
  var hint = document.querySelector('.inp-hint span:first-child');
  if(hint) hint.textContent = L.sendHint;
  // Settings title
  var stitle = document.querySelector('.settings-title');
  if(stitle) stitle.textContent = (lang==='en'?'‚öôÔ∏è Settings':'‚öôÔ∏è Param√®tres');
}

function loadLang(){
  var lang = localStorage.getItem('nx_lang')||'fr';
  applyLang(lang);
}

async function deleteAccount(){
  if(!confirm('‚ö†Ô∏è Supprimer d√©finitivement votre compte ? Cette action est irr√©versible.'))return;
  if(!sb||!currentUser){toast('Non connect√©.');return;}
  // Supprimer profil
  await sb.from('profiles').delete().eq('id',currentUser.id);
  // D√©connecter
  await sb.auth.signOut();
  currentUser=null;userProfile=null;
  localStorage.removeItem('nx_theme');localStorage.removeItem('nx_lang');
  showPage('login');
  toast('Compte supprim√©.');
}

// ‚îÄ‚îÄ PAYPAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function paypalPay(plan){
  var amount=plan==='monthly'?'6.99':'49.00';
  window.open('https://www.paypal.com/paypalme/louistoupin/'+amount+'EUR','_blank');
  toast('Apr√®s paiement, envoyez votre email √† info@nexus-ai.com pour activer le Premium ‚úâÔ∏è','success');
}

// ‚îÄ‚îÄ HISTORY (localStorage) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveHistory(){localStorage.setItem('nx_history',JSON.stringify(conversations));}
function loadHistoryFromStorage(){
  try{var d=localStorage.getItem('nx_history');if(d)conversations=JSON.parse(d);}catch(e){conversations={};}
}
function loadHistoryList(){
  loadHistoryFromStorage();
  var list=document.getElementById('histList');
  var keys=Object.keys(conversations).sort(function(a,b){return b-a;});
  if(keys.length===0){list.innerHTML='<div style="padding:8px 4px;font-size:12px;color:var(--muted)">Aucune conversation</div>';return;}
  list.innerHTML=keys.map(function(id){
    var c=conversations[id];
    var isActive=id===activeConvId;
    return '<div class="hist-item'+(isActive?' active':'')+'" onclick="loadConv(\''+id+'\')" id="hist-'+id+'">'+
      '<span style="flex:1;overflow:hidden;text-overflow:ellipsis">üí¨ '+esc(c.title||'Conversation')+'</span>'+
      '<span class="hist-item-del" onclick="delConv(event,\''+id+'\')">‚úï</span>'+
    '</div>';
  }).join('');
}
function loadConv(id){
  loadHistoryFromStorage();
  var c=conversations[id];
  if(!c)return;
  activeConvId=id;
  document.getElementById('chatTitle').textContent=c.title||'Conversation';
  var area=document.getElementById('msgArea');
  area.innerHTML='';
  (c.msgs||[]).forEach(function(m){
    if(m.role==='user')addMsgHTML('user',m.content,m.imgSrc);
    else if(m.role==='assistant')addMsgHTML('ai',m.content);
  });
  closeSidebar();
  loadHistoryList();
}
function delConv(e,id){
  e.stopPropagation();
  delete conversations[id];
  saveHistory();
  if(activeConvId===id){newChat();}
  else{loadHistoryList();}
}

// ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var chatMsgs=[],chatLoading=false;

function newChat(){
  chatMsgs=[];activeConvId=null;
  document.getElementById('chatTitle').textContent='NEXUS IA';
  document.getElementById('msgArea').innerHTML='<div class="chat-empty-state" id="chatEmpty"><div class="empty-orb">NX</div><div class="empty-title">Nexus IA est pr√™t</div><div class="empty-sub">Choisissez un mod√®le et commencez √† √©crire</div><div class="suggs"><div class="sugg" onclick="useSugg(this)">‚úçÔ∏è R√©dige un email professionnel</div><div class="sugg" onclick="useSugg(this)">üíª Aide-moi √† coder</div><div class="sugg" onclick="useSugg(this)">üí° Explique le machine learning</div><div class="sugg" onclick="useSugg(this)">üéØ Cr√©e une strat√©gie marketing</div></div></div>';
  pendingImages=[];renderImgPreview();
  loadHistoryList();
}

function updateBadge(){var s=document.getElementById('modelSel');document.getElementById('badgeModel').textContent=s.options[s.selectedIndex].text;}
function resizeInp(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,140)+'px';}
function onKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}}
function useSugg(el){var t=el.textContent.replace(/^[^\w]*/,'').trim();var i=document.getElementById('chatInput');i.value=t;resizeInp(i);i.focus();}
function closeModal(){document.getElementById('creditsModal').classList.remove('open');}

// IMAGE HANDLING
function handleImgSelect(evt){
  var files=evt.target.files;
  if(!files||!files.length)return;
  Array.from(files).forEach(function(file){
    if(!file.type.startsWith('image/'))return;
    var reader=new FileReader();
    reader.onload=function(e){
      pendingImages.push({base64:e.target.result.split(',')[1],type:file.type,thumb:e.target.result});
      renderImgPreview();
    };
    reader.readAsDataURL(file);
  });
  evt.target.value='';
}
function renderImgPreview(){
  var bar=document.getElementById('imgPreviewBar');
  if(!pendingImages.length){bar.className='img-preview-bar';bar.innerHTML='';return;}
  bar.className='img-preview-bar has-img';
  bar.innerHTML=pendingImages.map(function(img,i){
    return '<div style="position:relative;display:inline-block">'+
      '<img src="'+img.thumb+'" class="img-thumb">'+
      '<div class="img-remove" onclick="removeImg('+i+')">‚úï</div>'+
    '</div>';
  }).join('');
}
function removeImg(i){pendingImages.splice(i,1);renderImgPreview();}

// ADD MESSAGE TO DOM
function addMsgHTML(role,content,imgSrc){
  var empty=document.getElementById('chatEmpty');if(empty)empty.remove();
  var area=document.getElementById('msgArea');
  var div=document.createElement('div');div.className='message '+role;
  var imgHtml=imgSrc?'<img src="'+imgSrc+'" class="msg-img">':'';
  div.innerHTML='<div class="msg-av '+role+'">'+(role==='ai'?'NX':'YOU')+'</div><div class="msg-bub">'+imgHtml+fmt(content)+'</div>';
  area.appendChild(div);area.scrollTop=area.scrollHeight;
}
function addTyping(){var empty=document.getElementById('chatEmpty');if(empty)empty.remove();var area=document.getElementById('msgArea');var d=document.createElement('div');d.className='message ai';d.id='typDiv';d.innerHTML='<div class="msg-av ai">NX</div><div class="msg-bub"><div class="typing"><span></span><span></span><span></span></div></div>';area.appendChild(d);area.scrollTop=area.scrollHeight;}
function removeTyping(){var t=document.getElementById('typDiv');if(t)t.remove();}

function fmt(t){
  if(!t)return'<p></p>';
  t=t.replace(/```(\w*)\n?([\s\S]*?)```/g,function(_,l,c){return'<pre><code>'+esc(c.trim())+'</code></pre>';});
  t=t.replace(/`([^`]+)`/g,function(_,c){return'<code>'+esc(c)+'</code>';});
  t=t.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  t=t.replace(/\*(.+?)\*/g,'<em>$1</em>');
  t=t.split('\n\n').map(function(p){return p?'<p>'+p.replace(/\n/g,'<br>')+'</p>':'';}).join('');
  return t;
}
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

async function sendMsg(){
  if(chatLoading)return;
  var model=document.getElementById('modelSel').value;
  var text=document.getElementById('chatInput').value.trim();
  var imgs=[...pendingImages];
  if(!text&&!imgs.length)return;

  // V√©rifier cr√©dits
  if(userProfile){
    var left=getLeft();
    if(left<=0){
      var ri=ROLES[userProfile.role]||ROLES.normal;
      document.getElementById('creditsModalText').textContent='Vous avez utilis√© vos '+(ri.credits<999999?ri.credits:'')+'cr√©dits journaliers ('+ri.label+'). Revenez demain ou passez Premium !';
      document.getElementById('creditsModal').classList.add('open');
      return;
    }
  }

  document.getElementById('chatInput').value='';
  document.getElementById('chatInput').style.height='auto';
  pendingImages=[];renderImgPreview();

  // Afficher message user
  var imgSrc=imgs.length?imgs[0].thumb:null;
  addMsgHTML('user',text||'üì∑ Image',imgSrc);

  // Build API message content
  var content;
  if(imgs.length){
    content=[{type:'text',text:text||'Analyse cette image.'}];
    imgs.forEach(function(img){content.push({type:'image_url',image_url:{url:'data:'+img.type+';base64,'+img.base64}});});
  }else{
    content=text;
  }

  chatMsgs.push({role:'user',content:content});
  if(chatMsgs.length===1&&!activeConvId){
    activeConvId=Date.now().toString();
    var title=(text||'Image').slice(0,32)+(text&&text.length>32?'...':'');
    document.getElementById('chatTitle').textContent=title;
    conversations[activeConvId]={title:title,msgs:[]};
  }

  // Sauvegarder dans historique
  if(activeConvId){
    conversations[activeConvId].msgs.push({role:'user',content:text||'Image',imgSrc:imgSrc});
    saveHistory();loadHistoryList();
  }

  chatLoading=true;document.getElementById('sendBtn').disabled=true;addTyping();
  if(userProfile)await useCredit();

  fetch('https://openrouter.ai/api/v1/chat/completions',{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+OR_KEY,'HTTP-Referer':window.location.href,'X-Title':'Nexus AI'},
    body:JSON.stringify({model:model,max_tokens:1500,messages:[{role:'system',content:(localStorage.getItem('nx_lang')==='en'?"You are Nexus, an advanced AI assistant. Be precise, helpful and concise.":"Tu es Nexus, un assistant IA avanc√©. R√©ponds en fran√ßais sauf si l'utilisateur √©crit dans une autre langue. Sois pr√©cis, utile et concis.")}].concat(chatMsgs)})
  })
  .then(function(r){if(!r.ok)return r.json().then(function(d){throw{s:r.status,m:d&&d.error&&d.error.message};});return r.json();})
  .then(function(d){
    removeTyping();
    var reply=(d.choices&&d.choices[0]&&d.choices[0].message&&d.choices[0].message.content)||'(R√©ponse vide)';
    chatMsgs.push({role:'assistant',content:reply});
    addMsgHTML('ai',reply);
    if(activeConvId){conversations[activeConvId].msgs.push({role:'assistant',content:reply});saveHistory();}
  })
  .catch(function(e){
    removeTyping();chatMsgs.pop();
    if(e.s===401)toast('‚ùå Cl√© API invalide');
    else if(e.s===429)toast('‚è±Ô∏è Limite atteinte. Patientez.');
    else toast('‚ùå '+(e.m||e.message||'Erreur r√©seau'));
  })
  .finally(function(){chatLoading=false;document.getElementById('sendBtn').disabled=false;document.getElementById('chatInput').focus();});
}

// ‚îÄ‚îÄ API KEY MANAGER (Master only) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadApiKeyDisplay(){
  var key = localStorage.getItem('nx_api_key')||'';
  var masked = key ? '‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè ...'+key.slice(-8) : '‚ö†Ô∏è Aucune cl√© configur√©e';
  var el = document.getElementById('apiKeyMasked');
  if(el) el.textContent = masked;
  // Mettre a jour OR_KEY en m√©moire
  OR_KEY = key;
}

function editApiKey(){
  document.getElementById('apiKeyEditArea').style.display='block';
  document.getElementById('apiKeyDisplay').style.display='none';
  var inp = document.getElementById('apiKeyInput');
  inp.value = localStorage.getItem('nx_api_key')||'';
  inp.type = 'text';
  inp.focus();
}

function cancelApiKey(){
  document.getElementById('apiKeyEditArea').style.display='none';
  document.getElementById('apiKeyDisplay').style.display='flex';
  document.getElementById('apiKeyStatus').textContent='';
}

function saveApiKey(){
  var key = document.getElementById('apiKeyInput').value.trim();
  var status = document.getElementById('apiKeyStatus');
  if(!key){ status.textContent='‚ùå Entrez une cl√©.'; status.style.color='#f87171'; return; }
  if(!key.startsWith('sk-or-')){ status.textContent='‚ùå La cl√© doit commencer par sk-or-'; status.style.color='#f87171'; return; }
  localStorage.setItem('nx_api_key', key);
  OR_KEY = key;
  // Masquer et fermer
  document.getElementById('apiKeyEditArea').style.display='none';
  document.getElementById('apiKeyDisplay').style.display='flex';
  loadApiKeyDisplay();
  toast('Cl√© API sauvegard√©e ‚úì','success');
}

// ‚îÄ‚îÄ MASTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadMasterData(){
  if(!sb||!userProfile||userProfile.role!=='creator')return;
  var tbody=document.getElementById('usersTableBody');
  tbody.innerHTML='<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:32px">Chargement...</td></tr>';
  var r=await sb.from('profiles').select('*').order('created_at',{ascending:false});
  if(r.error){tbody.innerHTML='<tr><td colspan="7" style="text-align:center;color:#f87171;padding:24px">'+r.error.message+'</td></tr>';return;}
  var users=r.data||[];
  document.getElementById('statTotal').textContent=users.length;
  document.getElementById('statPremium').textContent=users.filter(function(u){return u.role==='premium';}).length;
  document.getElementById('statTesters').textContent=users.filter(function(u){return u.role==='tester';}).length;
  var now=new Date();
  document.getElementById('statOnline').textContent=users.filter(function(u){return u.last_seen&&(now-new Date(u.last_seen))<86400000;}).length;
  if(!users.length){tbody.innerHTML='<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:32px">Aucun utilisateur</td></tr>';return;}
  tbody.innerHTML=users.map(function(u,i){
    var ri=ROLES[u.role]||ROLES.normal;
    var isOn=u.last_seen&&(now-new Date(u.last_seen))<86400000;
    var max=ri.credits;
    var cred=(u.credits_used||0)+'/'+(max>=999999?'‚àû':max);
    var joined=u.created_at?new Date(u.created_at).toLocaleDateString('fr-FR'):'‚Äî';
    var pseudo=u.pseudo||'‚Äî';
    return '<tr>'+
      '<td style="color:var(--white);font-size:12px">'+esc(u.email||'‚Äî')+'</td>'+
      '<td style="color:var(--muted)">'+esc(pseudo)+'</td>'+
      '<td><span class="role-badge '+ri.cls+'">'+ri.label+'</span></td>'+
      '<td style="color:var(--muted)">'+cred+'</td>'+
      '<td style="color:var(--muted)">'+joined+'</td>'+
      '<td><span class="online-dot '+(isOn?'on':'off')+'"></span><span style="color:'+(isOn?'#4ade80':'var(--muted)')+'">'+(isOn?'En ligne':'Hors ligne')+'</span></td>'+
      '<td><div style="display:flex;gap:4px;flex-wrap:wrap">'+
        '<button class="btn-role btn-role-normal" onclick="setRole(\''+u.id+'\',\'normal\')">Normal</button>'+
        '<button class="btn-role btn-role-tester" onclick="setRole(\''+u.id+'\',\'tester\')">Testeur</button>'+
        '<button class="btn-role btn-role-premium" onclick="setRole(\''+u.id+'\',\'premium\')">Premium</button>'+
        '<button class="btn-role" style="background:rgba(139,92,246,.2);color:var(--violet-bright)" onclick="toggleDetail(\'d'+i+'\')">üîç</button>'+
      '</div>'+
      '<div class="user-detail-panel" id="d'+i+'">'+
        '<div class="detail-grid">'+
          '<div class="detail-item"><div class="detail-label">ID</div><div class="detail-value" style="font-size:10px;word-break:break-all">'+u.id+'</div></div>'+
          '<div class="detail-item"><div class="detail-label">Cr√©dits utilis√©s</div><div class="detail-value">'+cred+'</div></div>'+
          '<div class="detail-item"><div class="detail-label">Derni√®re activit√©</div><div class="detail-value" style="font-size:12px">'+(u.last_seen?new Date(u.last_seen).toLocaleString('fr-FR'):'‚Äî')+'</div></div>'+
        '</div>'+
        '<button class="btn-ghost" style="font-size:11px" onclick="resetCredits(\''+u.id+'\')">üîÑ Reset cr√©dits</button>'+
      '</div>'+
      '</td></tr>';
  }).join('');
}
function toggleDetail(id){var p=document.getElementById(id);if(p)p.classList.toggle('open');}
async function setRole(uid,role){if(!sb)return;var r=await sb.from('profiles').update({role:role}).eq('id',uid);if(r.error){toast('Erreur: '+r.error.message);return;}toast('R√¥le ‚Üí '+ROLES[role].label,'success');loadMasterData();}
async function resetCredits(uid){if(!sb)return;var r=await sb.from('profiles').update({credits_used:0,credits_reset_date:today()}).eq('id',uid);if(r.error){toast('Erreur: '+r.error.message);return;}toast('Cr√©dits r√©initialis√©s ‚úì','success');loadMasterData();}

// ‚îÄ‚îÄ CONTACT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sendContact(){var n=document.getElementById('cName').value.trim();var e=document.getElementById('cEmail').value.trim();var m=document.getElementById('cMsg').value.trim();if(!n||!e||!m){toast('Remplissez tous les champs.');return;}toast('Message envoy√© ‚úì','success');document.getElementById('cName').value='';document.getElementById('cEmail').value='';document.getElementById('cMsg').value='';}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var toastTmr;
function toast(msg,type){var t=document.getElementById('toast');t.textContent=msg;t.className='toast show'+(type?' '+type:'');clearTimeout(toastTmr);toastTmr=setTimeout(function(){t.classList.remove('show');},4500);}

// ‚îÄ‚îÄ SCROLL REVEAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initReveal(){var els=document.querySelectorAll('.reveal');var obs=new IntersectionObserver(function(entries){entries.forEach(function(e){if(e.isIntersecting)e.target.classList.add('visible');});},{threshold:.1});els.forEach(function(el){obs.observe(el);});}

// ‚îÄ‚îÄ SPACE CANVAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var canvas=document.getElementById('spaceCanvas'),ctx=canvas.getContext('2d'),stars=[],W,H;
function resizeCvs(){W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight;stars=[];for(var i=0;i<200;i++)stars.push({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.4+.2,o:Math.random(),tw:Math.random()*Math.PI*2});}
function drawSpace(){ctx.clearRect(0,0,W,H);var bg=ctx.createLinearGradient(0,0,W,H);bg.addColorStop(0,'#03010a');bg.addColorStop(.4,'#080420');bg.addColorStop(.7,'#0a0530');bg.addColorStop(1,'#03010a');ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);[{x:W*.15,y:H*.3,r:300,c:'rgba(75,15,212,0.1)'},{x:W*.85,y:H*.7,r:260,c:'rgba(107,44,245,0.08)'},{x:W*.5,y:H*.5,r:380,c:'rgba(30,5,80,0.12)'}].forEach(function(n){var g=ctx.createRadialGradient(n.x,n.y,0,n.x,n.y,n.r);g.addColorStop(0,n.c);g.addColorStop(1,'transparent');ctx.fillStyle=g;ctx.beginPath();ctx.ellipse(n.x,n.y,n.r,n.r*.6,.3,0,Math.PI*2);ctx.fill();});stars.forEach(function(s){s.tw+=.012;var o=s.o*(.5+.5*Math.sin(s.tw));ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fillStyle='rgba(200,210,255,'+o+')';ctx.fill();});requestAnimationFrame(drawSpace);}
window.addEventListener('resize',resizeCvs);resizeCvs();drawSpace();

// ‚îÄ‚îÄ START ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
loadTheme();
loadLang();
OR_KEY = localStorage.getItem('nx_api_key') || '';
initSupabase();
showPage('login');
</script>
</body>
</html>
